<!DOCTYPE html>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Void</title>

<style>
  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
  }

  html {
    color-scheme: light dark;
    background-color: #fff;
    color: #161616;
  }

  @media (prefers-color-scheme: dark) {
    html {
      background-color: #000;
      color: #fff;
    }
  }

  article {
    outline: none;
    padding: 18px max(18px, calc(50vw - 400px));
    width: 100%;
    min-height: 100vh;
    font: 18px / 1.5 system-ui;
    tab-size: 4;
    -webkit-font-smoothing: antialiased;
    text-rendering: optimizeLegibility;
    white-space: pre-wrap;
    overflow-wrap: break-word;
  }

  #hint {
    position: fixed;
    bottom: 12px;
    right: 18px;
    font: 12px system-ui;
    opacity: 0.4;
    user-select: none;
    pointer-events: none;
  }

  #status {
    position: fixed;
    bottom: 12px;
    left: 18px;
    font: 12px system-ui;
    opacity: 0;
    transition: opacity 0.3s;
    pointer-events: none;
  }
</style>

<article contenteditable="plaintext-only" spellcheck></article>
<div id="hint">Saved in the URL Â· copy the address bar to share</div>
<div id="status">saved</div>

<script>
  const article = document.querySelector('article')
  const status = document.getElementById('status')

  article.addEventListener('input', () => {
    detectRTL()
    debounce(500, save)()
  })
  addEventListener('DOMContentLoaded', load)
  addEventListener('hashchange', load)

  // Auto-detect Arabic for RTL
  function detectRTL() {
    const firstChar = article.textContent.trim().charAt(0)
    if (firstChar && /[\u0600-\u06FF]/.test(firstChar)) {
      article.style.direction = 'rtl'
      article.style.textAlign = 'right'
    } else {
      article.style.direction = 'ltr'
      article.style.textAlign = 'left'
    }
  }

  async function load() {
    try {
      if (location.hash !== '') {
        await set(location.hash)
      } else {
        await set(localStorage.getItem('hash') ?? '')
        if (article.textContent) history.replaceState({}, '', await get())
        article.focus()
      }
    } catch (e) {
      article.textContent = ''
      article.removeAttribute('style')
    }
    detectRTL()
    updateTitle()
  }

  async function save() {
    const hash = await get()
    if (location.hash !== hash) history.replaceState({}, '', hash)
    try { localStorage.setItem('hash', hash) } catch (e) {}
    updateTitle()
    whisper()
  }

  function whisper() {
    status.style.opacity = 0.5
    setTimeout(() => status.style.opacity = 0, 600)
  }

  async function set(hash) {
    if (!hash) return
    const [content, style] = (await decompress(hash.slice(1))).split('\x00')
    article.textContent = content
    if (style) article.setAttribute('style', style)
    detectRTL()
  }

  async function get() {
    const style = article.getAttribute('style')
    const content = article.textContent + (style !== null ? '\x00' + style : '')
    return '#' + await compress(content)
  }

  function updateTitle() {
    const match = article.textContent.match(/^\n*#(.+)\n/)
    document.title = match?.[1] ?? 'Void'
  }

  async function compress(string) {
    const byteArray = new TextEncoder().encode(string)
    const stream = new CompressionStream('deflate-raw')
    const writer = stream.writable.getWriter()
    writer.write(byteArray)
    writer.close()
    const buffer = await new Response(stream.readable).arrayBuffer()
    return new Uint8Array(buffer)
      .toBase64()
      .replace(/\+/g, "-")
      .replace(/\//g, "_")
  }

  async function decompress(b64) {
    const byteArray = Uint8Array.fromBase64(
      b64.replace(/-/g, "+").replace(/_/g, "/")
    )
    const stream = new DecompressionStream('deflate-raw')
    const writer = stream.writable.getWriter()
    writer.write(byteArray)
    writer.close()
    const buffer = await new Response(stream.readable).arrayBuffer()
    return new TextDecoder().decode(buffer)
  }

  function debounce(ms, fn) {
    let timer
    return (...args) => {
      clearTimeout(timer)
      timer = setTimeout(() => fn(...args), ms)
    }
  }

  addEventListener('keydown', e => {
    if (e.ctrlKey && e.shiftKey && e.key === 'X') {
      article.textContent = ''
      article.removeAttribute('style')
      history.replaceState({}, '', '#')
      localStorage.removeItem('hash')
    }

    if (e.ctrlKey && e.key === 's') {
      e.preventDefault()
      const blob = new Blob([article.textContent], { type: 'text/plain' })
      const a = document.createElement('a')
      a.href = URL.createObjectURL(blob)
      a.download = 'void.txt'
      a.click()
      URL.revokeObjectURL(a.href)
    }
  })
</script>
